<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
PUBLIC "-//mybatis.org//DTD Mapepr 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="storeMapper">
	<resultMap type="StoreCategory" id="category">
		<id property="cateCode" column="C_CODE"/>
		<result property="cateName" column="C_NAME"/>
		<result property="artiNameEn" column="ANTI_NAME_EN"/>
	</resultMap>
	<resultMap type="Store" id="storeResultSet">
		<id property="pcode" column="P_CODE"/>
		<result property="pname" column="P_NAME"/>
		<result property="salesQ" column="SALES_Q"/>
		<result property="qprice" column="Q_PRICE"/>
		<result property="discount" column="DISCOUNT"/>
		<result property="info" column="INFORMATION"/>
		<result property="isView" column="IS_VIEW"/>
		<result property="viewCount" column="VIEWCOUNT"/>
		<result property="isSoldout" column="IS_SOLDOUT"/>
		<result property="isActive" column="IS_ACTIVE"/>
		<result property="cateCode" column="C_CODE"/>
	</resultMap>
	<resultMap type="Attachment" id="attResultSet">
		<id property="attCode" column="ATT_CODE"/>
		<result property="attRoot" column="ATT_ROOT"/>
		<result property="attClName" column="ATT_CL_NAME"/>
		<result property="attSvName" column="ATT_SV_NAME"/>
		<result property="attStatus" column="ATT_STATUS"/>
		<result property="attMain" column="IS_MAIN_ATT"/>
		<result property="refId" column="P_CODE"/>
	</resultMap>
	<resultMap type="Wish" id="wishResultSet">
		<id property="code" column="P_CODE"/>
		<result property="wishDate" column="WISH_DATE"/>
		<result property="isWish" column="IS_WISH"/>
		<result property="id" column="ID"/>
	</resultMap>
	<resultMap type="StoreInfo" id="storInfoResultSet">
		<id property="pcode" column="P_CODE"/>
		<result property="origin" column="ORIGIN"/>
		<result property="brand" column="BRAND"/>
		<result property="contact" column="CONTACT"/>
		<result property="useTerm" column="USE_TERM"/>
		<result property="offerings" column="OFFERINGS"/>
		<result property="cancelInfo" column="CANCEL_INFO"/>
	</resultMap>
	<resultMap type="Review" id="reviewResultSet">
		<id property="rvCode" column="RV_CODE"/>
		<result property="rvScore" column="RV_SCORE"/>
		<result property="rvTitle" column="RV_TITLE"/>
		<result property="rvContent" column="RV_CONTENT"/>
		<result property="id" column="ID"/>
		<result property="bcode" column="B_CODE"/>
		<result property="pcode" column="P_CODE"/>
	</resultMap>
	<resultMap type="StoreCollection" id="storeCollResultSet">
		<collection property="store" resultMap="storeResultSet" />
		<collection property="att"  resultMap="attResultSet" />
		<collection property="wish"  resultMap="wishResultSet" />
		<collection property="storeInfo" resultMap="storInfoResultSet" />
		<collection property="review" resultMap="reviewResultSet" />
	</resultMap>
	<select id="selectCategoryList" parameterType="string" resultMap="category">
		SELECT
				DISTINCT C_NAME
			  , ARTI_NAME_EN
		  FROM
		  		S_CATEGORY
		 WHERE
		 		ARTI_NAME_EN = #{arti}
	  ORDER BY  C_NAME ASC
	</select>
	<select id="selectStoreList" resultMap="storeCollResultSet">
		SELECT 
				P_CODE
			  , P_NAME
			  , SALES_Q
			  , Q_PRICE
			  , DISCOUNT
			  , INFORMATION
			  , IS_VIEW
			  , VIEWCOUNT
			  , IS_SOLDOUT
			  , IS_ACTIVE
			  , C_CODE
			  , ATT_CODE
			  , ATT_ROOT
			  , ATT_CL_NAME
			  , ATT_SV_NAME
			  , ATT_STATUS
			  , IS_MAIN_ATT
			  , WISH_DATE
              , IS_WISH
              , ID
		  FROM 
		  		STORE
		  JOIN 
		  		ATT_STORE USING(P_CODE)
		  LEFT JOIN
		  		S_WISH USING(P_CODE)
		  LEFT JOIN
		  		S_CATEGORY USING(C_CODE)
		 WHERE
		 		C_NAME = #{cateName}
		   AND	IS_MAIN_ATT = 'Y'
		   AND  IS_ACTIVE = 'Y'
	  ORDER BY  P_CODE DESC
	</select>
	<select id="selectStoreListByCate" parameterType="hashMap" resultMap="storeCollResultSet">
		SELECT
				P_CODE
			  , P_NAME
			  , SALES_Q
			  , Q_PRICE
			  , DISCOUNT
			  , INFORMATION
			  , IS_VIEW
			  , VIEWCOUNT
			  , IS_SOLDOUT
			  , IS_ACTIVE
			  , C_CODE
			  , ATT_CODE
			  , ATT_ROOT
			  , ATT_CL_NAME
			  , ATT_SV_NAME
			  , ATT_STATUS
			  , IS_MAIN_ATT
			  , WISH_DATE
              , IS_WISH
              , ID
		  FROM 
		  		STORE
		  JOIN 
		  		ATT_STORE USING(P_CODE)
		  LEFT JOIN
		  		S_WISH USING(P_CODE)
	  <trim prefix="WHERE" prefixOverrides="AND|OR">
		 		C_CODE IN (SELECT C_CODE FROM S_CATEGORY WHERE C_NAME = #{cateName} AND ARTI_NAME_EN = #{artiName})
		   AND	IS_MAIN_ATT = 'Y'
		   AND  IS_ACTIVE = 'Y'
	  <if test='toggle.equals("NEW")'>
	  ORDER BY  P_CODE DESC
	  </if>
	  <if test='toggle.equals("TOP")'>
	  ORDER BY  VIEWCOUNT DESC
	  </if>
	  </trim>
	</select>
	<select id="isEnrollWish" parameterType="hashMap" resultType="_int">
		SELECT
				COUNT(*)
		  FROM
		  		S_WISH
		 WHERE
		 		ID = #{id}
		   AND
		   		P_CODE = #{pcode}
	</select>
	<insert id="enrollWish" parameterType="hashMap">
		INSERT
		INTO S_WISH
		(
			P_CODE
		  , WISH_DATE
		  , IS_WISH
		  , ID
		)
		VALUES
		(
			#{pcode}
		  , SYSDATE
		  , DEFAULT
		  , #{id}
		)
	</insert>
	<update id="updateWish" parameterType="hashMap">
		UPDATE
				S_WISH
		   SET
		   		IS_WISH = 'Y'
		 WHERE
		 		P_CODE = #{pcode}
		   AND
		   		ID = #{id}
	</update>
	<update id="cancelWish" parameterType="hashMap">
		UPDATE
				S_WISH
		   SET
		   		IS_WISH = 'N'
		 WHERE
		 		P_CODE = #{pcode}
		   AND
		   		ID = #{id}
	</update>
	<select id="searchStoreList" parameterType="hashMap" resultMap="storeCollResultSet">
		SELECT
				P_CODE
			  , P_NAME
			  , SALES_Q
			  , Q_PRICE
			  , DISCOUNT
			  , INFORMATION
			  , IS_VIEW
			  , VIEWCOUNT
			  , IS_SOLDOUT
			  , IS_ACTIVE
			  , C_CODE
			  , ATT_CODE
			  , ATT_ROOT
			  , ATT_CL_NAME
			  , ATT_SV_NAME
			  , ATT_STATUS
			  , IS_MAIN_ATT
			  , WISH_DATE
              , IS_WISH
              , ID
		  FROM 
		  		STORE
		  JOIN 
		  		ATT_STORE USING(P_CODE)
		  LEFT JOIN
		  		S_WISH USING(P_CODE)
	  <trim prefix="WHERE" prefixOverrides="AND|OR">
		 		C_CODE IN (SELECT C_CODE FROM S_CATEGORY WHERE C_NAME = #{cateName} AND ARTI_NAME_EN = #{artiName})
		   AND	IS_MAIN_ATT = 'Y'
		   AND  IS_ACTIVE = 'Y'
		   AND	P_NAME LIKE '%' || #{search} || '%'
	  <if test='toggle.equals("NEW")'>
	  ORDER BY  P_CODE DESC
	  </if>
	  <if test='toggle.equals("TOP")'>
	  ORDER BY  VIEWCOUNT DESC
	  </if>
	  </trim>
	</select>
	<select id="searchPrice" parameterType="_int" resultType="string">
		SELECT
				Q_PRICE
		  FROM
		  		STORE
		 WHERE
		 		P_CODE = #{pcode}
	</select>
	<insert id="insertCart" parameterType="hashMap">
		INSERT
		INTO CART
		(
			CART_CODE
		  , BUY_Q
		  , B_PRICE
		  , FEE
		  , ENROLL_DATE
		  , IS_BOUGHT
		  , P_CODE
		  , ID
		)
		VALUES
		(
			SEQ_CART.NEXTVAL
		  , 1
		  , #{price}
		  , DEFAULT
		  , SYSDATE
		  , DEFAULT
		  , #{pcode}
		  , #{id}
		)
	</insert>
	<insert id="insertStoreCategory" parameterType="StoreCollection">
		INSERT
		INTO S_CATEGORY
		(
			C_CODE
		  , C_NAME
		  , ARTI_NAME_EN
		)
		VALUES
		(
			SEQ_S_CATE.NEXTVAL
		  , #{storeCate.cateName}
		  , #{storeCate.artiNameEn}
		)
	</insert>
	<insert id="insertStore" parameterType="StoreCollection">
		INSERT
		INTO STORE
		(
			P_CODE
		  , P_NAME
		  , SALES_Q
		  , Q_PRICE
		  , DISCOUNT
		  , INFORMATION
		  , IS_VIEW
		  , VIEWCOUNT
		  , IS_SOLDOUT
		  , IS_ACTIVE
		  , C_CODE
		)
		VALUES
		(
			SEQ_STORE.NEXTVAL
		  , #{store.pname}
		  , #{store.salesQ}
		  , #{store.qprice}
		  , #{store.discount}
		  , #{store.info}
		  , #{store.isView}
		  , DEFAULT
		  , DEFAULT
		  , DEFAULT
		  , SEQ_S_CATE.CURRVAL
		)
	</insert>
	<insert id="insertStoreInfo" parameterType="StoreCollection">
		INSERT
		INTO P_INFO
		(
			P_CODE
		  , ORIGIN
		  , BRAND
		  , CONTACT
		  , USE_TERM
		  , OFFERINGS
		  , CANCEL_INFO
		)
		VALUES
		(
			SEQ_STORE.CURRVAL
		  , #{storeInfo.origin}
		  , #{storeInfo.brand}
		  , #{storeInfo.contact}
		  , #{storeInfo.useTerm}
		  , #{storeInfo.offerings}
		  , #{storeInfo.cancelInfo}
		)
	</insert>
	<insert id="insertStoreAtt">
		<foreach collection="list" item="i" index="index" open="INSERT ALL" close="SELECT * FROM DUAL">
		INTO ATT_STORE
		(
			ATT_CODE
		  , ATT_CL_NAME
		  , ATT_SV_NAME
		  , ATT_STATUS
		  , IS_MAIN_ATT
		  , P_CODE
		)
		VALUES
		(
			#{index} + SEQ_ATT_STORE.NEXTVAL
		  , #{i.attClName}
		  , #{i.attSvName}
		  , DEFAULT
		  , #{i.attMain}
		  , SEQ_STORE.CURRVAL
		)
		</foreach>
	</insert>
	<select id="selectStore" parameterType="string" resultMap="storeCollResultSet">
		SELECT
				P_CODE
			  , P_NAME
			  , SALES_Q
			  , Q_PRICE
			  , DISCOUNT
			  , INFORMATION
			  , IS_VIEW
			  , VIEWCOUNT
			  , IS_SOLDOUT
			  , IS_ACTIVE
			  , C_CODE
			  , ATT_CODE
			  , ATT_ROOT
			  , ATT_CL_NAME
			  , ATT_SV_NAME
			  , ATT_STATUS
			  , IS_MAIN_ATT
			  , WISH_DATE
              , IS_WISH
              , W.ID
              , ORIGIN
              , BRAND
              , CONTACT
              , USE_TERM
              , OFFERINGS
              , CANCEL_INFO
              , RV_CODE
              , RV_TITLE
              , RV_CONTENT
              , B_CODE
		  FROM 
		  		STORE S
		  JOIN 
		  		ATT_STORE USING(P_CODE)
		  LEFT JOIN
		  		S_WISH W USING(P_CODE)
          LEFT JOIN
                P_INFO USING(P_CODE)
          LEFT JOIN
                REVIEW USING(P_CODE)
        WHERE
                P_CODE = #{pcode}
		   AND  IS_ACTIVE = 'Y'
	  ORDER BY  RV_CODE DESC
	</select>
	<update id="updateReadCount" parameterType="string">
		UPDATE
				STORE
		   SET
		   		VIEWCOUNT = VIEWCOUNT + 1
		 WHERE
		 		P_CODE = #{pcode}
	</update>
</mapper>